services:
  pds:
    build:
      context: .
      dockerfile: Dockerfile.multi
    environment:
      # Coolify domain routing — enter your domain in Coolify UI
      - SERVICE_FQDN_PDS_3000

      # JWT secrets (auto-generated by Coolify, persisted across redeploys)
      - DALLAS_PDS_JWT__ACCESS_SECRET=${SERVICE_PASSWORD_64_JWT-ACCESS}
      - DALLAS_PDS_JWT__REFRESH_SECRET=${SERVICE_PASSWORD_64_JWT-REFRESH}

      # Core PDS config — set these in Coolify's env var UI
      - DALLAS_PDS_HOSTNAME=${PDS_HOSTNAME:?pds.example.com}
      - DALLAS_PDS_PUBLIC_URL=${PDS_PUBLIC_URL:?https://pds.example.com}
      - DALLAS_PDS_AVAILABLE_USER_DOMAINS=${PDS_USER_DOMAINS:?[".example.com"]}
      - DALLAS_PDS_PLC_URL=${PDS_PLC_URL:-https://plc.directory}
      - DALLAS_PDS_INVITE_REQUIRED=${PDS_INVITE_REQUIRED:-true}
      - DALLAS_PDS_ADMIN_DIDS=${PDS_ADMIN_DIDS:-[]}
      - DALLAS_PDS_MODE=Multi

      # Postgres (wired to the postgres service below)
      - DALLAS_PDS_DATABASE__URL=postgres://pds:${SERVICE_PASSWORD_64_POSTGRES}@postgres:5432/pds

      # S3-compatible blob storage (Bunny, R2, etc.) — set in Coolify UI
      - DALLAS_PDS_BLOBS__BUCKET=${S3_BUCKET:?}
      - DALLAS_PDS_BLOBS__REGION=${S3_REGION:?}
      - DALLAS_PDS_BLOBS__ENDPOINT=${S3_ENDPOINT:?}
      - AWS_ACCESS_KEY_ID=${S3_ACCESS_KEY:?}
      - AWS_SECRET_ACCESS_KEY=${S3_SECRET_KEY:?}

      # To proxy feed requests to an AppView, add:
      #   DALLAS_PDS_APPVIEW_URL=https://api.bsky.app
      #   DALLAS_PDS_APPVIEW_DID=did:web:api.bsky.app
      # To notify a relay after writes, add:
      #   DALLAS_PDS_RELAY_URL=https://bsky.network
      #
      # To enable SMTP for email verification / password reset, add:
      #   DALLAS_PDS_SMTP__HOST, DALLAS_PDS_SMTP__PORT,
      #   DALLAS_PDS_SMTP__USERNAME, DALLAS_PDS_SMTP__PASSWORD,
      #   DALLAS_PDS_SMTP__FROM_ADDRESS
      # All five must be set together or omitted entirely.
    volumes:
      - type: bind
        source: ./pds-data
        target: /app/data
        is_directory: true
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/xrpc/_health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres:
    image: postgres:17-bookworm
    environment:
      - POSTGRES_DB=pds
      - POSTGRES_USER=pds
      - POSTGRES_PASSWORD=${SERVICE_PASSWORD_64_POSTGRES}
    volumes:
      - type: bind
        source: ./pg-data
        target: /var/lib/postgresql/data
        is_directory: true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pds -d pds"]
      interval: 10s
      timeout: 5s
      retries: 5
